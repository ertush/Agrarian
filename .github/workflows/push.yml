name: agrarian-app-ci-workflow
on: 
  push:
    branches:
    - 'agrarian_docker_build'
    - '!test'
    - '!master'
    paths:
    - 'App/Build/**'
    - '.github/workflows/**'
    - '!README.md'
jobs:
  agrarian-app:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Build the docker-compose stack
      run: docker-compose -f App/Build/docker-compose.yaml up -d
    - name: Check running containers
      run: docker ps -a
    - name: Check log
      run: docker logs node-red-agrarian
    # - name: Testing node-red-backend
    #   run: docker run --network container:node-red-agrarian appropriate/curl -s --retry 10 --retry-connrefused http://localhost:1880/ 
    - name: check network
      run: docker network ls
    - name: Testing mqtt-broker
      run: nc -q 2 localhost 1883
    - name: Testing mongo-db
      run: nc -q 2 localhost 27017

    # steps:
    # - uses: actions/checkout@v1
    # - name: Install Node.js
    #   uses: actions/setup-node@v1
    #   with:
    #     node-version: '10.x'
    # - name: Install npm dependencies
    #   run: npm install
    # - name: Run build task
    #   run: npm run build --if-present
    # - name: Deploy to Server
    #   uses: easingthemes/ssh-deploy@v2.1.1
    #   env:
    #       SSH_PRIVATE_KEY: ${{ secrets.SERVER_SSH_KEY }}
    #       ARGS: "-rltgoDzvO --delete"
    #       SOURCE: "/"
    #       REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
    #       REMOTE_USER: ${{ secrets.REMOTE_USER }}
    #       TARGET: ${{ secrets.REMOTE_TARGET }}
    # - name: Rebuild App
    #   run: ssh agrarian@134.122.169.83 cd ./Agrarian/App/Build/docker-compose.yaml; sudo docker-compose up -d
